<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
"http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <title>CodeGenerationFramework</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <link rel="stylesheet" href="./static/css/blueprint/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="./static/css/blueprint/print.css" type="text/css" media="print">
    <!--[if lt IE 8]>
      <link rel="stylesheet" href="./static/css/blueprint/ie.css" type="text/css" media="screen, projection">
    <![endif]-->
    <link rel="stylesheet" href="./static/css/pygments/syntax.css" type="text/css">
    <link rel="stylesheet" href="./static/css/layout.css" type="text/css">
    <link rel="stylesheet" href="./static/css/colors.css" type="text/css">
    <script type="text/javascript" src="./static/js/graph.js"></script>
  </head>
  <body>
    <div class="container noshowgrid">
      <div class="span-20 prepend-2 append-2">
        <h1>CodeGenerationFramework</h1>
        <p>Our goal with this framework is to simplify generation of C code. Our goal is to be able to generate C code something like this:</p>
<pre><code>outCode :: CodeGenerator ()
outCode = do
    writeLine &quot;#include &lt;stdio.h&gt;&quot;
    writeLine &quot;&quot;
    writeLine &quot;int main() {&quot;
    indented $ do
        writeLine &quot;printf(\&quot;hello world\\n\&quot;);&quot;
        writeLine &quot;return 0;&quot;
    writeLine &quot;}&quot;</code></pre>
<p>And it generates this:</p>
<pre><code>#include &lt;stdio.h&gt;

int main() {
    printf(&quot;hello world\n&quot;);
    return 0;
}</code></pre>
<p>We will use the state monad to implement this framework. The state monad allows us to keep a state (the in-progress generated code) and update it in an imperative way while still being purely functional.</p>
<p>The <code>CodeGenerator</code> type is a synonym for a state:</p>
<pre><code>type CodeGenerator a = ST.State AccumulatedCode a</code></pre>
<p>The state in our case is defined like this:</p>
<pre><code>data AccumulatedCode = AccumulatedCode
    { counter     :: Int
    , globalNames :: [(String, String)]
    , code        :: String
    , indentCount :: Int
    }</code></pre>
<p>The <code>code</code> is the most important piece here. It contains the generated C code as it looks right now. When the whole generation is done, this code will be returned. A code generator can be passed to <code>runGenerator</code> to retrieve the generated code as a string. This function creates an initial state and returns the <code>code</code> field when the code generator has been run:</p>
<pre><code>runGenerator :: CodeGenerator () -&gt; String
runGenerator m = code $ ST.execState m (AccumulatedCode 0 [] &quot;&quot; 0)</code></pre>
<p><code>writeLine</code> is implemented like this:</p>
<pre><code>writeLine :: String -&gt; CodeGenerator ()
writeLine line = ST.modify (\s -&gt; s { code = code s ++ newLine s })
    where
        newLine   s = indentStr s ++ line ++ &quot;\n&quot;
        indentStr s = if null line
                          then &quot;&quot;
                          else concatMap (const &quot;    &quot;) [1..indentCount s]</code></pre>
<p>What we do here is modifying the state by appending a string to the <code>code</code> field. The string we add is <code>newLine</code>, and it contains the line passed to <code>writeLine</code> indented properly and with a newline character at the end. If we write the empty string (<code>line</code> is <code>null</code>), we don't indent anything.</p>
<p>The rest of this code can be found in <a href="https://github.com/rickardlindberg/compiler-tutorial/blob/master/src/CodeGenerationFramework.hs"><code>CodeGenerationFramework.hs</code></a>.</p>
<h2 id="continue">Continue</h2>
<p><a href="CodeGeneration.html" title="CodeGeneration">CodeGeneration</a></p>
        <hr />
        <svg xmlns="http://www.w3.org/2000/svg" id="canvas"></svg>
        <script type="text/javascript">
            var colors = function (level) {
                if (level == 1) {
                    return {
                        color: "#fcaf3e",
                        stroke: "#ab7423"
                    };
                } else if (level == 2) {
                    return {
                        color: "#fce94f",
                        stroke: "#c4a000"
                    };
                } else if (level == 3) {
                    return {
                        color: "#8ae234",
                        stroke: "#425d26"
                    };
                }
            };
            var goToPageFn = function(page) {
                return function() {
                    location.href = page + ".html";
                };
            };
            var g = new Graph("canvas", 800, 400);
            g.repulsion = g.repulsion / 2;
            //g.spring_length = 8;
            g.setCenter("CodeGenerationFramework");
            g.createVertex("CodeGenerationFramework", colors(1), goToPageFn("CodeGenerationFramework"));g.createVertex("CodeGeneration", colors(2), goToPageFn("CodeGeneration"));g.createVertex("AssembleHex", colors(3), goToPageFn("AssembleHex"));g.createVertex("RuntimeSupport", colors(3), goToPageFn("RuntimeSupport"));
            g.createEdge("CodeGenerationFramework", "CodeGeneration");g.createEdge("CodeGeneration", "AssembleHex");g.createEdge("CodeGeneration", "CodeGenerationFramework");g.createEdge("CodeGeneration", "RuntimeSupport");g.createEdge("AssembleHex", "CodeGeneration");g.createEdge("AssembleHex", "RuntimeSupport");g.createEdge("RuntimeSupport", "CodeGeneration");
            g.go();
        </script>
        <hr />
        <p>
        <center>
        1. <a href="HomePage.html">HomePage</a>
        |
        2. <a href="StageParsing.html">StageParsing</a>
        |
        3. <a href="RuntimeSupport.html">RuntimeSupport</a>
        |
        4. <a href="CodeGeneration.html">CodeGeneration</a>
        |
        5. <a href="AssembleHex.html">AssembleHex</a>
        |
        6. <a href="MovingForward.html">MovingForward</a>
        </center>
        </p>
        <hr />

        <div id="disqus_thread"></div>
        <script type="text/javascript">
        var disqus_shortname = 'compilertutorial';
        (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

        <hr />
      </div>
    </div>
  </body>
</html>